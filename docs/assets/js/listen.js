
audio_static_filenames = [
    [  // Sequences 0 and 1 : interpolation [140524] 'WindEns2Ed' --> [3037] 'HARD ROADS'
        'assets/interpolation/135_spinvae/audio_step00.mp3',
        'assets/interpolation/135_spinvae/audio_step01.mp3',
        'assets/interpolation/135_spinvae/audio_step02.mp3',
        'assets/interpolation/135_spinvae/audio_step03.mp3',
        'assets/interpolation/135_spinvae/audio_step04.mp3',
        'assets/interpolation/135_spinvae/audio_step05.mp3',
        'assets/interpolation/135_spinvae/audio_step06.mp3',
    ],
    [
        'assets/interpolation/135_reference/audio_step00.mp3',
        'assets/interpolation/135_reference/audio_step01.mp3',
        'assets/interpolation/135_reference/audio_step02.mp3',
        'assets/interpolation/135_reference/audio_step03.mp3',
        'assets/interpolation/135_reference/audio_step04.mp3',
        'assets/interpolation/135_reference/audio_step05.mp3',
        'assets/interpolation/135_reference/audio_step06.mp3',
    ],
    [  // Sequences 2 and 3 : interpolation [1610] 'ABU ASHRAM' --> [52680] 'STARRY  1 '
        'assets/interpolation/6_spinvae/audio_step00.mp3',
        'assets/interpolation/6_spinvae/audio_step01.mp3',
        'assets/interpolation/6_spinvae/audio_step02.mp3',
        'assets/interpolation/6_spinvae/audio_step03.mp3',
        'assets/interpolation/6_spinvae/audio_step04.mp3',
        'assets/interpolation/6_spinvae/audio_step05.mp3',
        'assets/interpolation/6_spinvae/audio_step06.mp3',
    ],
    [
        'assets/interpolation/6_reference/audio_step00.mp3',
        'assets/interpolation/6_reference/audio_step01.mp3',
        'assets/interpolation/6_reference/audio_step02.mp3',
        'assets/interpolation/6_reference/audio_step03.mp3',
        'assets/interpolation/6_reference/audio_step04.mp3',
        'assets/interpolation/6_reference/audio_step05.mp3',
        'assets/interpolation/6_reference/audio_step06.mp3',
    ],
    [  // Sequences 4 and 5 : interpolation [77275] 'AnlgSyn.45' --> [71973] 'ClinkieBel'
        'assets/interpolation/254_spinvae/audio_step00.mp3',
        'assets/interpolation/254_spinvae/audio_step01.mp3',
        'assets/interpolation/254_spinvae/audio_step02.mp3',
        'assets/interpolation/254_spinvae/audio_step03.mp3',
        'assets/interpolation/254_spinvae/audio_step04.mp3',
        'assets/interpolation/254_spinvae/audio_step05.mp3',
        'assets/interpolation/254_spinvae/audio_step06.mp3',
    ],
    [
        'assets/interpolation/254_reference/audio_step00.mp3',
        'assets/interpolation/254_reference/audio_step01.mp3',
        'assets/interpolation/254_reference/audio_step02.mp3',
        'assets/interpolation/254_reference/audio_step03.mp3',
        'assets/interpolation/254_reference/audio_step04.mp3',
        'assets/interpolation/254_reference/audio_step05.mp3',
        'assets/interpolation/254_reference/audio_step06.mp3',
    ],
    [  // Sequences 6 and 7 : interpolation [5567] 'METALFUNK ' --> [77695] 'Build.Drum'
        'assets/interpolation/263_spinvae/audio_step00.mp3',
        'assets/interpolation/263_spinvae/audio_step01.mp3',
        'assets/interpolation/263_spinvae/audio_step02.mp3',
        'assets/interpolation/263_spinvae/audio_step03.mp3',
        'assets/interpolation/263_spinvae/audio_step04.mp3',
        'assets/interpolation/263_spinvae/audio_step05.mp3',
        'assets/interpolation/263_spinvae/audio_step06.mp3',
    ],
    [
        'assets/interpolation/263_reference/audio_step00.mp3',
        'assets/interpolation/263_reference/audio_step01.mp3',
        'assets/interpolation/263_reference/audio_step02.mp3',
        'assets/interpolation/263_reference/audio_step03.mp3',
        'assets/interpolation/263_reference/audio_step04.mp3',
        'assets/interpolation/263_reference/audio_step05.mp3',
        'assets/interpolation/263_reference/audio_step06.mp3',
    ],
    [  // Sequences 8 and 9 : interpolation [77020] 'Revers1   ' --> [78203] 'SuperGrand'
        'assets/interpolation/302_spinvae/audio_step00.mp3',
        'assets/interpolation/302_spinvae/audio_step01.mp3',
        'assets/interpolation/302_spinvae/audio_step02.mp3',
        'assets/interpolation/302_spinvae/audio_step03.mp3',
        'assets/interpolation/302_spinvae/audio_step04.mp3',
        'assets/interpolation/302_spinvae/audio_step05.mp3',
        'assets/interpolation/302_spinvae/audio_step06.mp3',
    ],
    [
        'assets/interpolation/302_reference/audio_step00.mp3',
        'assets/interpolation/302_reference/audio_step01.mp3',
        'assets/interpolation/302_reference/audio_step02.mp3',
        'assets/interpolation/302_reference/audio_step03.mp3',
        'assets/interpolation/302_reference/audio_step04.mp3',
        'assets/interpolation/302_reference/audio_step05.mp3',
        'assets/interpolation/302_reference/audio_step06.mp3',
    ],
    [  // Sequence 10 : extrapolation BOUM -> fuzzerro
        'assets/extrapolation/199874_to_016527/-2.mp3',
        'assets/extrapolation/199874_to_016527/-1.mp3',
        'assets/extrapolation/199874_to_016527/00.mp3',
        'assets/extrapolation/199874_to_016527/01.mp3',
        'assets/extrapolation/199874_to_016527/02.mp3',
        'assets/extrapolation/199874_to_016527/03.mp3',
        'assets/extrapolation/199874_to_016527/04.mp3',
        'assets/extrapolation/199874_to_016527/05.mp3',
        'assets/extrapolation/199874_to_016527/06.mp3',
        'assets/extrapolation/199874_to_016527/07.mp3',
        'assets/extrapolation/199874_to_016527/08.mp3',
    ],
    [  // Sequence 11 : extrapolation INDIA 1 -> Tonewheel2
        'assets/extrapolation/006777_to_246833/-2.mp3',
        'assets/extrapolation/006777_to_246833/-1.mp3',
        'assets/extrapolation/006777_to_246833/00.mp3',
        'assets/extrapolation/006777_to_246833/01.mp3',
        'assets/extrapolation/006777_to_246833/02.mp3',
        'assets/extrapolation/006777_to_246833/03.mp3',
        'assets/extrapolation/006777_to_246833/04.mp3',
        'assets/extrapolation/006777_to_246833/05.mp3',
        'assets/extrapolation/006777_to_246833/06.mp3',
        'assets/extrapolation/006777_to_246833/07.mp3',
        'assets/extrapolation/006777_to_246833/08.mp3',
    ],
];

// Seems to solve the Safari (iOS and macOS) issue: sounds sometimes does not play
//    The issue was observed on the 'instructions' pages. So it *probably* comes from
//    not using the audio/buttons for a few dozens of seconds.
// autoSuspend's default is true (sound engine stops after 30s)
Howler.autoSuspend = false;
HowlerGlobal.autoSuspend = false;

__debug_prints = true;

// Sounds - "Automatic caching for improved performance"
let sounds = [];  // 1st dim: sequence (we may have only 1); 2nd dim: actual audio filename
for (let i=0; i < audio_static_filenames.length; i++) {
    sounds.push([]);
    audio_static_filenames[i].forEach(
        audio_filename => sounds[i].push(new Howl({
            src: [audio_filename],
            onload: function() {
                //console.log("SOUND LOADED");
            },
            onloaderror: function(sound_ID, error_code) {
                console.log("SOUND LOAD ERROR id = " + sound_ID + '   code = ' + error_code);
            },
            onplayerror: function(sound_ID, error_code) {
                console.log("SOUND PLAY ERROR id = " + sound_ID + '   code = ' + error_code);
            },
        }))
    );
}


// ==================== Global vars and utility functions ====================

var isPlayingWholeSequence = false;
var currentSequenceIndex = -1;  // sequence being played (or just 1 sound from this seq is being played)
var currentSoundIndex = sounds.length;  // index of the sound being played

window.onload = (event) => {
};


function playSound(seq_index, sound_idx) {
    if (__debug_prints)
        console.log("playSound(seq_index=" + seq_index + ", sound_index=" + sound_idx + ")");
    sounds[seq_index][sound_idx].play();
    document.getElementById("seq" + seq_index + "_wave" + sound_idx).style.visibility = 'visible';
}

function stopAllSounds() {
    // Stop all sounds, disable the corresponding waveforms
    for (let seq_index = 0; seq_index < sounds.length ; seq_index++) {
        for (const [index, sound] of sounds[seq_index].entries()) {
            sound.stop();
            soundwave_image = document.getElementById("seq" + seq_index + "_wave" + index);
            if (soundwave_image === null)
                console.error("ID 'seq" + seq_index + "_wave" + index + "' can't be found");
            soundwave_image.style.visibility = 'hidden';
        }
    }
}


// ==================== Callbacks from howler.js  ====================
for (let seq_index = 0; seq_index < sounds.length ; seq_index++) {
    for (const [__index, sound] of sounds[seq_index].entries()) {
        sound.on('end', function () {
            onSoundEnds(seq_index, __index)  // TODO register callbacks during construction of Howl objects
        });
    }
}

function onSoundEnds(seq_index, sound_index) {
    document.getElementById("seq" + seq_index + "_wave" + sound_index).style.visibility = 'hidden';

    if (isPlayingWholeSequence) {
        if (currentSequenceIndex < 0 || currentSequenceIndex >= sounds.length)
            throw new Error("Invalid currentSequenceIndex value: " + currentSequenceIndex);
        // A/B sequence, or not? negative indices indicate start/end before playing the actual sequence
        if (currentSoundIndex < 0) {
            if (currentSoundIndex === -2)
                playSound(currentSequenceIndex, sounds[currentSequenceIndex].length - 1);
            else if (currentSoundIndex === -1)
                playSound(currentSequenceIndex, 0);
            else
                throw new Error("Invalid currentSoundIndex value: " + currentSoundIndex + ". onSoundEnds index is " + sound_index);
            currentSoundIndex += 1;
        }
        else {  // "normal" sequence playing (consecutive samples only)
            if (sound_index < (sounds[currentSequenceIndex].length - 1)) {  // keep playing?
                playSound(currentSequenceIndex, sound_index + 1);
                currentSoundIndex += 1;
            }
            else { // otherwise: end of sequence - everything has been played
                isPlayingWholeSequence = false;
                currentSequenceIndex = -1;
            }
        }
    }
}


// ==================== Callbacks on user input ====================
function onPlayButtonClicked(seq_index, sound_idx) {
    if (__debug_prints)
        console.log("onPlay:    seq_index: " + seq_index + "   sound_idx: " + sound_idx);

    // We consider that the user forces the sequence to stop (if was playing)
    isPlayingWholeSequence = false;
    currentSequenceIndex = -1;
    currentSoundIndex = sounds.length;
    // stop all, Then start the new one
    stopAllSounds();
    playSound(seq_index, sound_idx);
}

function onPlaySequenceButtonClicked(seq_index) {  // Plays the full sequence, once
    if (__debug_prints)
        console.log("playSeq " + seq_index);

    isPlayingWholeSequence = false;
    currentSequenceIndex = -1;
    stopAllSounds();
    // Trigger the first sound, each sound will trigger the next one on own end
    currentSoundIndex = 0;
    isPlayingWholeSequence = true;
    currentSequenceIndex = seq_index;
    playSound(seq_index, 0);
}

function onPlayABSequenceButtonClicked(seq_index) {  // Play A (start sample), then B (end sample), then the full sequence
    if (__debug_prints)
        console.log("playABSeq " + seq_index);

    isPlayingWholeSequence = false;
    currentSequenceIndex = -1;
    stopAllSounds();
    // Trigger the first sound, each sound will trigger the next one on own end
    currentSoundIndex = -2;  // -2 correspond to A, -1 to B, and 0 indicates the first "normal" seq index
    isPlayingWholeSequence = true;
    currentSequenceIndex = seq_index;
    playSound(seq_index, 0);  // on Sound Ends will handle the following sounds
}

